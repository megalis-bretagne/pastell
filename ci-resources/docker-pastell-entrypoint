#! /bin/bash
set -e

# Activation ou non de XDEBUG
if [ -z ${XDEBUG_ON} ]
then
    if [ -f /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini ]
    then
        rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    fi
else
    docker-php-ext-enable xdebug
fi

/bin/bash /var/www/pastell/ci-resources/docker-pastell-init > /data/config/DockerSettings.php

#A mettre dans le dockerfile ?
usermod -s /bin/bash www-data

# Génération fichier ssmtp.conf
/bin/bash /var/www/pastell/ci-resources/generate-ssmtp.conf.sh > /etc/ssmtp/ssmtp.conf


# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi


# Certbot
if [ "$LETSENCRYPT_DOMAIN" ] ; then
    if [ -f "/etc/apache2/ssl/fullchain.pem" ] ; then
            certbot renew
    else
        certbot --standalone --noninteractive --agree-to --preferred-challenges http -d ${LETSENCRYPT_DOMAIN} -m ${LETSENCRYPT_EMAIL} certonly
        ln -s /etc/letsencrypt/live/pastell2.test.libriciel.fr/fullchain.pem /etc/apache2/ssl/
        ln -s /etc/letsencrypt/live/pastell2.test.libriciel.fr/privkey.pem /etc/apache2/ssl/
    fi

fi



php /var/www/pastell/ci-resources/init-docker.php



exec "$@"
