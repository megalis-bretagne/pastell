#! /bin/bash
set -e

/bin/bash /var/www/pastell/ci-resources/docker-pastell-init > /data/config/DockerSettings.php

# Génération fichier ssmtp.conf
if [ "$SMTP_SERVER" ] ; then
  /bin/bash /var/www/pastell/ci-resources/generate-msmtp.conf.sh > /data/config/msmtprc
  chmod 600 /data/config/msmtprc
fi

# Utilisation de l'authentification cliente si nécessaire
if [ "$AUTHENTICATION_WITH_CLIENT_CERTIFICATE" ] ; then
    sed -i 's/# SSLVerifyclient optional/SSLVerifyclient optional/' /etc/apache2/sites-available/pastell-apache-config.conf
fi


# Certbot
if [ "$LETSENCRYPT_DOMAIN" ] ; then
    if [ -f "/data/certificate/fullchain.pem" ] ; then
            certbot  --logs-dir /data/log/ --work-dir /data/run --http-01-port 8080 renew
    else
        certbot --http-01-port 8080 --logs-dir /data/log/ --work-dir /data/run --standalone --noninteractive --agree-to --preferred-challenges http -d ${LETSENCRYPT_DOMAIN} -m ${LETSENCRYPT_EMAIL} certonly
        ln -s /etc/letsencrypt/live/${LETSENCRYPT_DOMAIN}/fullchain.pem /data/certificate/
        ln -s /etc/letsencrypt/live/${LETSENCRYPT_DOMAIN}/privkey.pem /data/certificate/
    fi

fi

if [ -z "$DONT_RETRIEVE_VALIDCA" ] ; then
  if [ ! -d /data/certificate/validca ] ; then
      echo "Récupération des CRL"
      curl -s https://validca.libriciel.fr/retrieve-validca.sh | bash -s /data/certificate
  fi
fi

if [ -z "$DONT_INIT_DATABASE" ] ; then
  php /var/www/pastell/ci-resources/init-docker.php
fi

exec "$@"
