nom: Actes réponse préfecture

description: |
	Flux Actes réponse préfecture permettant de récupérer les réponses de la préfecture.

connecteur:
	TdT

formulaire:
    Réponse de la préfecture:

        acte_nature:
            name: Nature de l'acte
            read-only: true
            type: select
            requis: true
            value:
                3: Actes individuels
                2: Actes réglementaires
                6: Autres
                4: "Contrats, conventions et avenants"
                1: Délibérations
                5: Documents budgétaires et financiers

        numero_de_lacte:
            name: Numéro de l'acte
            read-only: true
            index: true
            title: true

        type_reponse:
            name: Type de réponse
            read-only: true
            index: true
            type: select
            value:
                2: Courrier simple
                3: Demande de pièces complémentaires
                4: Lettre d'observation
                5: Déféré au tribunal administratif

        related_transaction_id:
            name: Identifiant de la transaction acte
            read-only: true

        transaction_id:
            name: Identifiant de la transaction réponse
            read-only: true

        last_status_id:
            name: Identifiant du statut
            read-only: true

    Courrier Simple:
        has_courrier_simple:
            no-show: true
        courrier_simple:
            name: Courrier simple (original)
            type: file
            read-only: true
        courrier_simple_unzip:
            name: Fichiers décompressés
            type: file
            multiple: true
            read-only: true
        courrier_simple_id:
            no-show: true
        courrier_simple_date:
            name: Date de réception du courrier simple
            type: date
        has_reponse_courrier_simple:
            no-show: true
        reponse_courrier_simple:
            name: Réponse à un courrier simple
            commentaire: "format PDF"
            requis: true
            type: file
            read-only-content:
                has_reponse_courrier_simple: true
        type_piece_courrier_simple:
            name: Typologie des pièces
            type: externalData
            link_name: liste des types de pièces
            choice-action: cs-reponse-type-piece
            edit-only: true
        type_piece_fichier_courrier_simple:
            name: Typologie des pièces
            type: file
            visionneuse: TypologieActesVisionneuse
            read-only: true
            requis: true
            visionneuse-no-link: true
        type_acte_courrier_simple:
            no-show: true
            onchange: cs-type-acte-change-by-api
        type_pj_courrier_simple:
            no-show: true
            onchange: cs-type-acte-change-by-api
        empty_courrier_simple:
            type: file
            no-show: true
        courrier_simple_response_transaction_id:
            name: Identifiant de la transaction réponse à un courrier simple
            read-only: true

    Demande de pièces complementaires:
        has_demande_piece_complementaire:
            no-show: true
        demande_piece_complementaire:
            name: Demande de pièces complémentaires
            type: file
            read-only: true
        demande_piece_complementaire_unzip:
            name: Fichiers décompressés
            type: file
            multiple: true
            read-only: true
        demande_piece_complementaire_id:
            no-show: true
        demande_piece_complementaire_date:
            name: Date de réception de la demande de pièces complémentaires
            type: date
        has_reponse_demande_piece_complementaire:
            no-show: true
        reponse_demande_piece_complementaire:
            name: Première pièce complémentaire
            commentaire: "format PDF"
            requis: true
            type: file
            read-only-content:
                has_reponse_demande_piece_complementaire: true
        reponse_pj_demande_piece_complementaire:
            name: Autres pièces complémentaire
            commentaire: "format PDF"
            type: file
            multiple: true
            read-only-content:
                has_reponse_demande_piece_complementaire: true
            onchange: pc-reponse_pj_demande_piece_complementaire-change
        nature_reponse_demande_piece_complementaire:
            name: Nature de la réponse
            requis: true
            type: select
            value:
                3: Refus de réponse
                4: Réponse
            read-only-content:
                has_reponse_demande_piece_complementaire: true
        type_piece_demande_piece_complementaire:
            name: Typologie des pièces
            type: externalData
            link_name: liste des types de pièces
            choice-action: pc-reponse-type-piece
            edit-only: true
        type_piece_fichier_demande_piece_complementaire:
            name: Typologie des pièces
            type: file
            visionneuse: TypologieActesVisionneuse
            read-only: true
            requis: true
            visionneuse-no-link: true
        type_acte_demande_piece_complementaire:
            no-show: true
            onchange: pc-type-acte-change-by-api
        type_pj_demande_piece_complementaire:
            no-show: true
            onchange: pc-type-acte-change-by-api
        demande_piece_complementaire_response_transaction_id:
            name: Identifiant de la transaction réponse à la demande de pièce complémentaire
            read-only: true
        demande_piece_complementaire_has_acquittement:
            name: Acquittement de la réponse à la demande de pièce complémentaire reçu
            type: checkbox
        demande_piece_complementaire_acquittement_file:
            name: Accusé de réception à la demande de pièce complémentaire
            type: file

    Lettre d'observation:
        has_lettre_observation:
            no-show: true
        lettre_observation:
            name: Lettre d'observation
            type: file
            read-only: true
        lettre_observation_unzip:
            name: Fichiers décompressés
            type: file
            multiple: true
            read-only: true
        lettre_observation_id:
            no-show: true
        lettre_observation_date:
            name: Date de réception de la lettre d'observation
            type: date
        has_reponse_lettre_observation:
            no-show: true
        reponse_lettre_observation:
            name: Réponse à la lettre d'observation
            commentaire: "format PDF"
            requis: true
            type: file
            read-only-content:
                has_reponse_lettre_observation: true
        nature_reponse_lettre_observation:
            name: Nature de la réponse
            requis: true
            type: select
            value:
                3: Refus de réponse
                4: Réponse
            read-only-content:
                has_reponse_lettre_observation: true
        type_piece_lettre_observation:
            name: Typologie des pièces
            type: externalData
            link_name: liste des types de pièces
            choice-action: lo-reponse-type-piece
            edit-only: true
        type_piece_fichier_lettre_observation:
            name: Typologie des pièces
            type: file
            visionneuse: TypologieActesVisionneuse
            read-only: true
            requis: true
            visionneuse-no-link: true
        type_acte_lettre_observation:
            no-show: true
            onchange: lo-type-acte-change-by-api
        type_pj_lettre_observation:
            no-show: true
            onchange: lo-type-acte-change-by-api
        empty_lettre_observation:
            type: file
            no-show: true
        lettre_observation_response_transaction_id:
            name: Identifiant de la transaction réponse à la lettre d'observation
            read-only: true
        lettre_observation_has_acquittement:
            name: Acquittement de la réponse à la lettre d'observation reçu
            type: checkbox
        lettre_observation_acquittement_file:
            name: Accusé de réception à la lettre d'observation
            type: file

    Déféré au tribunal administratif:
        has_defere_tribunal_administratif:
            no-show: true
        defere_tribunal_administratif:
            name: Déféré au tribunal administratif
            type: file
            read-only: true
        defere_tribunal_administratif_unzip:
            name: Fichiers décompressés
            type: file
            multiple: true
            read-only: true
        defere_tribunal_administratif_id:
            no-show: true
        defere_tribunal_administratif_date:
            name: Date du déféré au TA
            type: date


champs-affiches:
    titre
    type_reponse
    entite
    dernier_etat
    date_dernier_etat

page-condition:

    Courrier Simple:
        has_courrier_simple: true

    Demande de pièces complementaires:
        has_demande_piece_complementaire: true

    Lettre d'observation:
        has_lettre_observation: true

    Déféré au tribunal administratif:
        has_defere_tribunal_administratif: true


action:

    creation:
        name-action: Créer
        name: Créé
        rule:
            no-last-action:
            droit_id_u: 'actes-reponse-prefecture:edition'

    modification:
        name-action: Modifier
        name: En cours de rédaction
        rule:
            last-action:
                creation
                modification
                attente-reponse-prefecture
            role_id_e: editeur
            droit_id_u: 'actes-reponse-prefecture:edition'

    supression:
        name-action: Supprimer
        name: Supprimé
        rule:
            last-action:
                creation
                modification
                termine
                fatal-error
                tdt-error
                attente-reponse-prefecture
            role_id_e: editeur
            droit_id_u: 'actes-reponse-prefecture:edition'
        action-class: Supprimer
        warning: "Êtes-vous sûr ?"

    erreur-verif-tdt:
        name: Erreur lors de la vérification du statut de l'acte
        rule:
            role_id_e: no-role

    tdt-error:
        name: Erreur sur le TdT
        rule:
            role_id_e: no-role

    attente-reponse-prefecture:
        name: Réponse à la préfecture attendue
        rule:
            role_id_e: no-role
        editable-content:
            reponse_courrier_simple
            type_piece_courrier_simple
            reponse_lettre_observation
            nature_reponse_lettre_observation
            type_piece_lettre_observation
            nature_reponse_demande_piece_complementaire
            reponse_demande_piece_complementaire
            reponse_pj_demande_piece_complementaire
            type_piece_demande_piece_complementaire

    verif-reponse-tdt:
        name-action: Vérifier l'acquittement
        name: Acquittement de la réponse reçu
        rule:
            last-action:
                send-reponse-prefecture
                tdt-error
                erreur-verif-tdt
            role_id_e: editeur
            droit_id_u: 'actes-reponse-prefecture:edition'
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtVerifReponsePref
        connecteur-type-mapping:
            acte_transaction_id: related_transaction_id
            reponse_transaction_id: transaction_id
            type_reponse: type_reponse

    send-reponse-prefecture:
        name: Envoi de la réponse à la préfecture
        name-action: Envoyer la réponse à la préfecture
        rule:
            no-action:
                send-reponse-prefecture
            has-action:
                attente-reponse-prefecture
            droit_id_u: 'actes-reponse-prefecture:edition'
            document_is_valide: true
            or_1:
                and_1:
                    content:
                        has_lettre_observation: true
                        has_reponse_lettre_observation: false
                and_2:
                    content:
                        has_demande_piece_complementaire: true
                        has_reponse_demande_piece_complementaire: false
                and_3:
                    content:
                        has_courrier_simple: true
                        has_reponse_courrier_simple: false
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtSendReponsePref

    lo-reponse-type-piece:
        name: Typologie des pièces
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardChoiceAction
        connecteur-type: TdT
        connecteur-type-action: TdtChoiceTypologieActes
        connecteur-type-mapping:
            arrete: reponse_lettre_observation
            autre_document_attache: empty_lettre_observation
            type_acte: type_acte_lettre_observation
            type_pj: type_pj_lettre_observation
            type_piece: type_piece_lettre_observation
            type_piece_fichier: type_piece_fichier_lettre_observation

    lo-type-acte-change-by-api:
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtTypologieChangeByApi
        connecteur-type-mapping:
            type_acte: type_acte_lettre_observation
            type_pj: type_pj_lettre_observation
            type_piece: type_piece_lettre_observation
            type_piece_fichier: type_piece_fichier_lettre_observation


    cs-reponse-type-piece:
        name: Typologie des pièces
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardChoiceAction
        connecteur-type: TdT
        connecteur-type-action: TdtChoiceTypologieActes
        connecteur-type-mapping:
            arrete: reponse_courrier_simple
            autre_document_attache: empty_courrier_simple
            type_acte: type_acte_courrier_simple
            type_pj: type_pj_courrier_simple
            type_piece: type_piece_courrier_simple
            type_piece_fichier: type_piece_fichier_courrier_simple

    cs-type-acte-change-by-api:
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtTypologieChangeByApi
        connecteur-type-mapping:
            type_acte: type_acte_courrier_simple
            type_pj: type_pj_courrier_simple
            type_piece: type_piece_courrier_simple
            type_piece_fichier: type_piece_fichier_courrier_simple

    pc-reponse-type-piece:
        name: Typologie des pièces
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardChoiceAction
        connecteur-type: TdT
        connecteur-type-action: TdtChoiceTypologieActes
        connecteur-type-mapping:
            arrete: reponse_demande_piece_complementaire
            autre_document_attache: reponse_pj_demande_piece_complementaire
            type_acte: type_acte_demande_piece_complementaire
            type_pj: type_pj_demande_piece_complementaire
            type_piece: type_piece_demande_piece_complementaire
            type_piece_fichier: type_piece_fichier_demande_piece_complementaire

    pc-type-acte-change-by-api:
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtTypologieChangeByApi
        connecteur-type-mapping:
            type_acte: type_acte_demande_piece_complementaire
            type_pj: type_pj_demande_piece_complementaire
            type_piece: type_piece_demande_piece_complementaire
            type_piece_fichier: type_piece_fichier_demande_piece_complementaire

    pc-reponse_pj_demande_piece_complementaire-change:
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: StandardAction
        connecteur-type: TdT
        connecteur-type-action: TdtAnnexeTypologieAnnexeChange
        connecteur-type-mapping:
            autre_document_attache: reponse_pj_demande_piece_complementaire
            type_pj: type_pj_demande_piece_complementaire
            type_piece: type_piece_demande_piece_complementaire
            type_piece_fichier: type_piece_fichier_demande_piece_complementaire


    termine:
        name: Traitement terminé
        rule:
            role_id_e: no-role

