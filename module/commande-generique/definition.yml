nom: 'Commande (générique)'
description: "Type de dossier permettant l'enregistrement d'une commande au format PDF, puis le passage à la signature,\npuis l'envoi de la facture par mail sécurisé, \npuis l'envoi à la GED et au SAE (facultatif)"
connecteur:
    - signature
    - mailsec
    - GED
    - 'Bordereau SEDA'
    - SAE
formulaire:
    Commande:
        libelle:
            name: Libellé
            requis: true
            title: true
        commande:
            name: 'Bon de commande'
            requis: true
            content-type: application/pdf
            type: file
            commentaire: 'format PDF'
        autre_document_attache:
            name: 'Annexe(s)'
            type: file
            multiple: true
        id_fournisseur:
            name: 'Identifiant fournisseur'
        nom_fournisseur:
            name: 'Nom du fournisseur'
            requis: true
        adresse_fournisseur:
            name: 'Adresse du fournisseur'
        mail_fournisseur:
            name: 'Adresse e-mail du fournisseur'
            requis: true
        date_emission:
            name: "Date d'émission"
            type: date
        lieu_livraison:
            name: 'Lieu de livraison'
        prix_total_ht:
            name: 'Prix total HT'
        tva:
            name: TVA
            type: checkbox
        taux_tva:
            name: 'Taux de TVA (%)'
        total_ttc:
            name: 'Prix total TTC'
    Budget:
        siret:
            name: 'Numéro SIRET (entité)'
        budget:
            name: Budget
        imputation_budgetaire:
            name: 'Imputation budgétaire'
        service_gestionnaire:
            name: 'Service gestionnaire'
        num_bon_commande:
            name: 'Numéro du bon de commande'
        num_engagement:
            name: "Numéro d'engagement"
        num_marche:
            name: 'Numéro de marché'
    Cheminement:
        envoi_signature:
            name: 'Transmission à la signature'
            type: checkbox
            onchange: envoi-change
        envoi_mailsec:
            name: 'Transmission au fournisseur par mail sécurisé'
            type: checkbox
        envoi_ged:
            name: 'Transmission à la GED'
            type: checkbox
        envoi_sae:
            name: 'Transmission au SAE'
            type: checkbox
        envoi_auto:
            name: "Envoyer automatiquement les dossiers d'étape en étape"
            type: checkbox
    Parapheur:
        iparapheur_type:
            name: 'Type iparapheur'
            read-only: true
        iparapheur_sous_type:
            name: 'Sous-type iparapheur'
            requis: true
            read-only: true
            type: externalData
            choice-action: iparapheur-sous-type
            link_name: 'Sélectionner un sous-type'
    'Retour Parapheur':
        iparapheur_dossier_id:
            name: 'Identifiant du dossier sur le parapheur'
        has_historique:
            no-show: true
        iparapheur_historique:
            name: 'Historique iparapheur'
            type: file
        parapheur_last_message:
            name: 'Dernier message reçu du parapheur'
        has_signature:
            no-show: true
        signature:
            name: 'Signature zip'
            type: file
        bordereau:
            name: 'Bordereau de signature'
            type: file
        document_orignal:
            name: 'Bon de commande original (avant signature)'
            type: file
        iparapheur_annexe_sortie:
            name: 'Annexe(s) de sortie du parapheur'
            type: file
            multiple: true
    'Mail fournisseur':
        has_message:
            no-show: true
        to:
            name: Destinataire
        objet:
            name: Objet
        Message:
            type: textarea
        document_attache:
            name: 'Documents attachés'
            type: file
            multiple: true
        key:
            no-show: true
    'Retour GED':
        has_ged_document_id:
            no-show: true
        ged_document_id_file:
            name: 'Identifiants des documents sur la GED'
            type: file
            visionneuse: Pastell\Viewer\GedIdDocumentsViewer
            read-only: true
            requis: true
            visionneuse-no-link: true
    SAE:
        sae_show:
            no-show: true
        journal:
            name: 'Faisceau de preuves'
            type: file
        date_journal_debut:
            name: 'Date du premier évènement journalisé'
        date_cloture_journal:
            name: 'Date de clôture du journal'
        date_cloture_journal_iso8601:
            name: 'Date de clôture du journal (iso 8601)'
        sae_transfert_id:
            name: 'Identifiant de transfert'
            index: true
        sae_bordereau:
            name: 'Bordereau SEDA'
            type: file
        sae_archive:
            name: "Paquet d'archive (SIP)"
            type: file
        ar_sae:
            type: file
            name: 'Accusé de réception SAE'
        sae_ack_comment:
            name: "Commentaire de l'accusé de réception"
        reply_sae:
            type: file
            name: 'Réponse du SAE'
        sae_archival_identifier:
            name: "Identifiant de l'archive sur le SAE"
        sae_atr_comment:
            name: 'Commentaire de la réponse du SAE'
page-condition:
    Parapheur:
        envoi_signature: true
    'Retour Parapheur':
        has_historique: true
    'Mail fournisseur':
        has_message: true
    'Retour GED':
        has_ged_document_id: true
    SAE:
        sae_show: true
action:
    creation:
        name-action: Créer
        name: Créé
        rule:
            no-last-action: ''
    modification:
        name-action: Modifier
        name: 'En cours de rédaction'
        rule:
            last-action:
                - creation
                - modification
                - recu-iparapheur
                - recu-iparapheur-etat
                - envoi-mail
                - reception
                - reception-etat
                - renvoi
                - send-ged
                - send-ged-etat
                - termine
    supression:
        name-action: Supprimer
        name: Supprimé
        rule:
            last-action:
                - creation
                - modification
                - recu-iparapheur
                - recu-iparapheur-etat
                - rejet-iparapheur
                - erreur-verif-iparapheur
                - envoi-mail
                - reception-etat
                - send-ged
                - send-ged-etat
                - accepter-sae
                - rejet-sae
                - termine
                - fatal-error
        action-class: Supprimer
        warning: 'Êtes-vous sûr ?'
    orientation:
        name: Orientation
        rule:
            role_id_e: no-role
        action-class: FournisseurCommandeOrientation
    termine:
        name: 'Traitement terminé'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_ged
            - envoi_sae
    prepare-iparapheur:
        name-action: "Préparation de l'envoi au parapheur"
        name: "Préparation de l'envoi au iparapheur"
        rule:
            role_id_e: no-role
        action-automatique: send-iparapheur
    send-iparapheur:
        name-action: 'Transmettre au parapheur'
        name: 'Transmis au parapheur'
        rule:
            last-action:
                - creation
                - modification
            document_is_valide: true
            content:
                envoi_signature: true
            no-action:
                - send-iparapheur
        action-class: StandardAction
        action-automatique: verif-iparapheur
        connecteur-type: signature
        connecteur-type-action: SignatureEnvoie
        connecteur-type-mapping:
            objet: libelle
            document: commande
    verif-iparapheur:
        name-action: 'Vérifier le statut de signature'
        name: 'Vérification de la signature'
        rule:
            last-action:
                - erreur-verif-iparapheur
                - send-iparapheur
        action-class: FournisseurCommandeReceptionParapheur
        connecteur-type: signature
    erreur-verif-iparapheur:
        name: 'Erreur lors de la vérification du statut de signature'
        rule:
            role_id_e: no-role
    recu-iparapheur:
        name: 'Signature récupérée'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_mailsec
            - envoi_ged
            - envoi_sae
        action-automatique: orientation
    recu-iparapheur-etat:
        name: 'État signature récupérée'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_mailsec
            - envoi_ged
            - envoi_sae
    rejet-iparapheur:
        name: 'Signature refusée'
        rule:
            role_id_e: no-role
    prepare-envoi-mail:
        name: "Préparation de l'envoi du mail au fournisseur"
        rule:
            role_id_e: no-role
        action-automatique: envoi-mail
    envoi-mail:
        name: 'Mail envoyé au fournisseur'
        name-action: 'Envoyer un mail au fournisseur'
        rule:
            content:
                envoi_mailsec: true
            no-action:
                - envoi-mail
            document_is_valide: true
            or_1:
                and_1:
                    content:
                        envoi_signature: false
                    last-action:
                        - modification
                        - prepare-envoi-mail
                and_2:
                    last-action:
                        - recu-iparapheur
                        - recu-iparapheur-etat
                and_3:
                    has-action:
                        - recu-iparapheur
                    no-action:
                        - send-ged
                        - generate-sip
        editable-content:
            - envoi_ged
            - envoi_sae
        action-class: FournisseurCommandeEnvoiMail
        action-automatique: mailsec-attente
    prepare-renvoi:
        name: 'Préparation de la relance du mail'
        rule:
            role_id_e: no-role
        action-automatique: renvoi
    erreur:
        name: Erreur
        rule:
            role_id_e: no-role
    mailsec-attente:
        name: 'Vérification de réception'
        name-action: 'Vérification de réception'
        rule:
            last-action:
                - envoi-mail
                - renvoi
        action-class: FournisseurCommandeAttente
        action-automatique: mailsec-attente
    non-recu:
        name: 'Non reçu'
        name-action: 'Définir comme non reçu'
        warning: ok
        rule:
            last-action:
                - renvoi
                - envoi-mail
        action-class: StandardAction
        connecteur-type: mailsec
        connecteur-type-action: MailsecNotReceived
        action-automatique: orientation
    reception:
        name: 'Mail reçu par le fournisseur'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_ged
            - envoi_sae
        action-automatique: orientation
    reception-etat:
        name: 'État Mail traité'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_ged
            - envoi_sae
    renvoi:
        name-action: 'Envoyer à nouveau au fournisseur'
        name: Renvoyé
        rule:
            last-action:
                - envoi-mail
            role_id_e: editeur
            document_is_valide: true
        editable-content:
            - envoi_ged
            - envoi_sae
        action-class: FournisseurCommandeRenvoyerMail
        action-automatique: mailsec-attente
    prepare-ged:
        name: "Préparation de l'envoi à la GED"
        rule:
            role_id_e: no-role
        action-automatique: send-ged
    send-ged:
        name-action: 'Verser à la GED'
        name: 'Versé à la GED'
        rule:
            content:
                envoi_ged: true
            no-action:
                - send-ged
            document_is_valide: true
            or_1:
                and_1:
                    last-action:
                        - non-recu
                        - reception
                        - reception-etat
                        - prepare-ged
                        - error-ged
                    no-action:
                        - generate-sip
                and_2:
                    last-action:
                        - modification
                    content:
                        envoi_mailsec: false
                        envoi_signature: false
                    no-action:
                        - generate-sip
                and_3:
                    has-action:
                        - recu-iparapheur
                    content:
                        envoi_mailsec: false
                    no-action:
                        - generate-sip
                and_4:
                    has-action:
                        - reception
                        - non-recu
                    no-action:
                        - generate-sip
        editable-content:
            - envoi_sae
        action-class: StandardAction
        connecteur-type: GED
        connecteur-type-action: GEDEnvoyer
        connecteur-type-mapping:
            fatal-error: error-ged
        action-automatique: orientation
    error-ged:
        name: 'Erreur irrécupérable lors du dépôt'
        rule:
            role_id_e: no-role
    send-ged-etat:
        name: 'État Versé à la GED'
        rule:
            role_id_e: no-role
        editable-content:
            - envoi_sae
    preparation-send-sae:
        name: "Préparation de l'envoi au SAE"
        rule:
            role_id_e: no-role
        action-automatique: generate-sip
    generate-sip:
        name-action: "Générer le paquet d'archive (SIP) et envoyer au SAE"
        name: "Paquet d'archive (SIP) généré"
        rule:
            content:
                envoi_sae: true
            document_is_valide: true
            or_1:
                and_1:
                    last-action:
                        - preparation-send-sae
                        - generate-sip-error
                        - rejet-sae
                        - erreur-envoie-sae
                and_2:
                    last-action:
                        - modification
                    content:
                        envoi_signature: false
                        envoi_mailsec: false
                        envoi_ged: false
                and_3:
                    has-action:
                        - recu-iparapheur
                    content:
                        envoi_mailsec: false
                        envoi_ged: false
                    no-action:
                        - send-archive
                and_4:
                    has-action:
                        - non-recu
                        - reception
                    content:
                        envoi_ged: false
                    no-action:
                        - send-archive
                and_5:
                    has-action:
                        - send-ged
                        - error-ged
                    no-action:
                        - send-archive
        action-class: StandardAction
        connecteur-type: SAE
        connecteur-type-action: Pastell\Step\SAE\Action\SAEGenerateArchiveAction
        action-automatique: send-archive
        connecteur-type-mapping:
            generate-sip-error: generate-sip-error
            sae_show: sae_show
            sae_bordereau: sae_bordereau
            sae_archive: sae_archive
            journal: journal
            date_journal_debut: date_journal_debut
            date_cloture_journal: date_cloture_journal
            date_cloture_journal_iso8601: date_cloture_journal_iso8601
    generate-sip-error:
        name: "Erreur lors de la génération de l'archive"
        rule:
            role_id_e: no-role
    send-archive:
        name-action: 'Verser au SAE'
        name: 'Versé au SAE'
        rule:
            last-action:
                - generate-sip
                - rejet-sae
                - erreur-envoie-sae
        action-class: StandardAction
        connecteur-type: SAE
        connecteur-type-action: Pastell\Step\SAE\Action\SAESendArchiveAction
        action-automatique: verif-sae
        connecteur-type-mapping:
            sae_transfert_id: sae_transfert_id
            sae_bordereau: sae_bordereau
            sae_archive: sae_archive
            erreur-envoie-sae: erreur-envoie-sae
    erreur-envoie-sae:
        name: "Erreur lors de l'envoi au SAE"
        rule:
            role_id_e: no-role
    verif-sae:
        name-action: "Récupérer l'AR du document sur le SAE"
        name: "Récuperation de l'AR sur le SAE"
        rule:
            last-action:
                - send-archive
                - verif-sae-erreur
        action-class: StandardAction
        connecteur-type: SAE
        connecteur-type-action: SAEVerifier
        connecteur-type-mapping:
            sae_transfert_id: sae_transfert_id
            ar_sae: ar_sae
            ar-recu-sae: ar-recu-sae
            verif-sae-erreur: verif-sae-erreur
            sae_ack_comment: sae_ack_comment
            sae_bordereau: sae_bordereau
            ack-not-provided: ack-not-provided
    verif-sae-erreur:
        name: "Erreur lors de la récupération de l'AR"
        rule:
            role_id_e: no-role
    ar-recu-sae:
        name: 'AR SAE reçu'
        rule:
            role_id_e: no-role
        action-automatique: validation-sae
    ack-not-provided:
        name: 'En attente de la validation par le SAE'
        rule:
            role_id_e: no-role
        action-automatique: validation-sae
    validation-sae:
        name-action: "Vérifier l'acceptation par le SAE"
        name: "Vérification de l'acceptation par le SAE"
        rule:
            last-action:
                - ar-recu-sae
                - ack-not-provided
                - validation-sae-erreur
        action-class: StandardAction
        connecteur-type: SAE
        connecteur-type-action: SAEValider
        connecteur-type-mapping:
            sae_transfert_id: sae_transfert_id
            reply_sae: reply_sae
            erreur-envoie-sae: erreur-envoie-sae
            validation-sae-erreur: validation-sae-erreur
            accepter-sae: accepter-sae
            rejet-sae: rejet-sae
            sae_atr_comment: sae_atr_comment
            sae_archival_identifier: sae_archival_identifier
            sae_bordereau: sae_bordereau
    validation-sae-erreur:
        name: 'Erreur lors de la vérification de la validité du transfert'
        rule:
            role_id_e: no-role
    accepter-sae:
        name: 'Transfert accepté par le SAE'
        rule:
            role_id_e: no-role
        action-automatique: orientation
    rejet-sae:
        name: 'Transfert rejeté par le SAE'
        rule:
            role_id_e: no-role
    iparapheur-sous-type:
        name: 'Liste des sous-type iparapheur'
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: IparapheurSousType
    envoi-change:
        name: 'Modification des envois'
        no-workflow: true
        rule:
            role_id_e: no-role
        action-class: FournisseurCommandeEnvoieChange
