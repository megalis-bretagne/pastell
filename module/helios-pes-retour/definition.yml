nom: Helios PES Retour

type: Flux Généraux

description:| 
	Flux Hélios PES Retour permettant de traiter les réponses d'hélios.
	Permet de les envoyer à une GED ou à un SAE.

connecteur:
	TdT
	GED
	SAE
	Bordereau SEDA

affiche_one: true

formulaire:
	PES:
		Objet: {requis: true, title: true}	
		fichier_pes: {name: Fichier PES Retour, type: file, requis: true, commentaire: "format XML"}
		id_retour: 
			no-show: true		
		date_tdt: {name: Date de réception Tdt, type: date}		
		envoi_ged:
			name: Transmission à la GED
			type: checkbox		
		envoi_sae:
			name: Transmission au SAE
			type: checkbox
			onchange: envoi-sae-change
	SAE:
		ar_sae: {type: file, name: Accusé de réception SAE}
		reply_sae: {type: file, name: Réponse du SAE}
		url_archive: {name: URL sur le système d'archive, type: url}
		
page-condition:	
	SAE:
		ar_sae: true

action:
	creation:		
		name-action: Créer
		name: Créé		
		rule:
			no-last-action:
			droit_id_u: 'helios-pes-retour:edition'
			type_id_e: 
				service
				collectivite
		
	modification:	
		name-action: Modifier
		name: En cours de rédaction		
		rule:
			last-action: 
				creation
				modification
				get-pes
				send-ged
			droit_id_u: 'helios-pes-retour:edition'
				
	supression:
		name-action: Supprimer
		name: Supprimé	
		rule:
			last-action: 
				creation
				modification
				get-pes
				send-ged
			droit_id_u: 'helios-pes-retour:edition'			
		action-class: Supprimer
		warning: "Êtes-vous sûr ?"

	get-pes:
		name-action: Importer à nouveau
		name: Importé à nouveau
		rule:
			last-action: 
				creation
				modification
				get-pes
		action-class: HeliosRecupPESRetour
	
	tdt-error:
		name: Erreur sur le TdT
		rule:
			role_id_e: no-role	

	send-ged:
		name-action: Verser à la GED
		name: Versé à la GED
		rule:
			content:
				envoi_ged: true
			last-action: 
				creation
				modification
			document_is_valide: true
		editable-content:
			envoi_sae
		action-class: HeliosGEDEnvoi
			
	send-archive:
		name-action: Verser au SAE
		name: Versé au SAE
		rule:
			content:
				envoi_sae: true
			or_1:
				and_1:
					last-action: 
						creation
						modification
					document_is_valide: true
					content:
						envoi_ged: false
				and_2:
					last-action:
						send-ged
						erreur-envoie-sae
						rejet-sae
		action-class: SAEEnvoiHelios
		action-automatique: verif-sae

	erreur-envoie-sae:
		name: Erreur lors de l'envoi au SAE
		rule:
			role_id_e: no-role

	verif-sae:
		name-action: Récupérer l'AR du document sur le SAE
		name: Récupération de l'AR sur le SAE
		rule:
			last-action:
				send-archive
				verif-sae-erreur
			droit_id_u: 'helios-pes-retour:edition'
		action-class: HeliosGeneriqueSAEVerif

	verif-sae-erreur:
		name: Erreur lors de la récupération de l'AR
		rule:
			role_id_e: no-role		
			
	ar-recu-sae:
		name: AR SAE reçu
		rule:
			role_id_e: no-role
		action-automatique: validation-sae
	
	validation-sae:
		name-action: Vérifier l'acceptation par le SAE
		name: Vérification de l'acceptation par le SAE
		rule:
			last-action:
				ar-recu-sae
				validation-sae-erreur
			droit_id_u: 'helios-pes-retour:edition'
		action-class: HeliosGeneriqueSAEValidation
		
	validation-sae-erreur:
		name: Erreur lors de la vérification de la validité du transfert
		rule:
			role_id_e: no-role	
		
	accepter-sae:
		name: Archive acceptée par le SAE
		rule:
			role_id_e: no-role
			
	rejet-sae:
		name: Archive rejetée par le SAE
		rule: 
			role_id_e: no-role

	envoi-sae-change:
		name: Modification envoi_sae
		no-workflow: true
		rule: 
			role_id_e: no-role
		action-class: HeliosEnvoieSAEChange
		
			

