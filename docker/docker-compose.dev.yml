services:
  web:
    image: pastell-local-dev
    build:
      context: ..
      target: pastell_dev
      args:
        GITHUB_API_TOKEN: ${GITHUB_API_TOKEN:-}
        UID: ${UID:-33}
        GID: ${GID:-33}
        USERNAME: ${USERNAME:-www-data}
        GROUPNAME: ${GROUPNAME:-www-data}
    environment:
      XDEBUG_MODE: "develop, coverage, debug"
      MAILER_DSN: "smtp://maildev:1025?verify_peer=0"
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      PACK_TEST: true
    volumes:
      - ..:/var/www/pastell:cached

  db:
    volumes:
      - ./docker/mysql-dev/:/etc/mysql/conf.d/
    ports:
      - "${DATABASE_PORT:-8306}:3306"

  db_test:
    image: hubdocker.libriciel.fr/mariadb:10.9.3-jammy
    command:
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_USER: ${MYSQL_USER_TEST:-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD_TEST:-user}
      MYSQL_DATABASE: ${MYSQL_DATABASE_TEST:-pastell_test}
    volumes:
      - ${MARIADB_DATADIR_TEST:-mariadb_datadir_test}:/var/lib/mysql/
    ports:
      - "${DATABASE_TEST_PORT:-13306}:3306"

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    links:
      - db:db
    ports:
      - "${PHPMYADMIN_WEB_PORT:-8001}:80"

  phpmyadmin_test:
    image: phpmyadmin/phpmyadmin
    links:
      - db_test:db
    ports:
      - "${PHPMYADMIN_TEST_PORT:-8004}:80"

  php-redis-admin:
    image: faktiva/php-redis-admin
    environment:
      - PHPREDMIN_DATABASE_REDIS_0_HOST=redis
    ports:
      - "${PHP_REDIS_PORT:-8005}:80"
    depends_on:
      - redis

  glaneur-sftp:
    image: atmoz/sftp
    volumes:
      - ${PASTELL_GLANEUR:-pastell_glaneur}:/home/${SFTP_USER:-ftp}
    ports:
      - "${SFTP_PORT:-2222}:22"
    command: ${SFTP_USER:-ftp}:${SFTP_PASSWORD:-ftp}:33

  # Add the following line to your .env for using maildev
  # MAILER_DSN=smtp://maildev:1025?verify_peer=0
  maildev:
    image: maildev/maildev
    ports:
      - "1080:1080"

volumes:
  pastell_glaneur:
  mariadb_datadir_test: